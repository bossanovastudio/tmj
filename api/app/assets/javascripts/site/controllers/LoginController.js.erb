tmj.controller('LoginController', function($rootScope, $scope, $http, $sce, $compile, $routeParams, $location) {

    $rootScope.pageName = 'login';
    $('.initial-loading').hide(0);

    $scope.form = {};

    $scope.form.code = $location.search().code;

    $scope.passwords = [{
        id: 0,
        value: 'mon',
        name: 'monica',
        img: '<%= asset_url('site/monica.png') %>'
    }, {
        id: 1,
        value: 'ceb',
        name: 'cebola',
        img: '<%= asset_url('site/cebola.png') %>'
    }, {
        id: 2,
        value: 'cas',
        name: 'cascao',
        img: '<%= asset_url('site/cascao.png') %>'
    }, {
        id: 3,
        value: 'mag',
        name: 'magali',
        img: '<%= asset_url('site/magali.png') %>'
    }, {
        id: 4,
        value: 'mar',
        name: 'marina',
        img: '<%= asset_url('site/marina.png') %>'
    }, {
        id: 5,
        value: 'den',
        name: 'denise',
        img: '<%= asset_url('site/denisejovem.png') %>'
    }, {
        id: 6,
        value: 'xav',
        name: 'xaveco',
        img: '<%= asset_url('site/xaveco.png') %>'
    }, {
        id: 7,
        value: 'car',
        name: 'carmen',
        img: '<%= asset_url('site/carmen.png') %>'
    }, {
        id: 8,
        value: 'doc',
        name: 'docontra',
        img: '<%= asset_url('site/docontra.png') %>'
    }, {
        id: 9,
        value: 'nim',
        name: 'nimbus',
        img: '<%= asset_url('site/nimbus.png') %>'
    }];

    $scope.passwordChoice = [{
        img: '<%= asset_url('site/pass-silhuete.svg') %>',
        value: 0
    }, {
        img: '<%= asset_url('site/pass-silhuete.svg') %>',
        value: 0
    }, {
        img: '<%= asset_url('site/pass-silhuete.svg') %>',
        value: 0
    }, {
        img: '<%= asset_url('site/pass-silhuete.svg') %>',
        value: 0
    }];
    $scope.numClick = 0;

    $scope.open = false;
    $scope.togglePassword = function() {
        $scope.open = !$scope.open;
        if ($scope.open) {
            $('.overlay-pass').css({ "display": "block" });
            $scope.passwordChoice.length = 0;
            $('.after').css({ "left": 10 });
            $scope.numClick = 0;
        } else {
            $('.overlay-pass').css({ "display": "none" });
        }
    };

    $scope.addToPasswordChoice = function(pass) {
        $scope.numClick = $scope.numClick + 1;
        $scope.passwordChoice.push($scope.passwords[pass.id]);
        if ($scope.numClick == 1) {
            $('.after').css({ "left": 55 });
        } else if ($scope.numClick == 2) {
            $('.after').css({ "left": 105 });
        } else if ($scope.numClick == 3) {
            $('.after').css({ "left": 150 });
        } else {
            $scope.numClick = 0;
            $scope.open = !$scope.open;
            $('.overlay-pass').css({ "display": "none" });
        }
    }

    $scope.msg = 'Minha Área';
    $scope.msg_register = 'Cadastrar';

    $scope.login = function() {
        $scope.form.password = $scope.passwordChoice.map(function(p) {
            return p.value;
        }).join('');

        if (!$scope.form.username || $scope.form.username.length < 1) {
            $scope.msg = 'Preencha seu apelido';
            return false;
        } else if ($scope.form.password.length != 12) {
            $scope.msg = 'Senha inválida';
            return false;
        }
        $scope.msg = 'Minha Área';
        $http.post("/user/sign_in.json", {
                user: $scope.form
            }, {
                headers: { 'Content-Type': 'application/json' }
            })
            .then(function(response) {
                $scope.msg = 'Obrigado.';
                storage.set('user', response.data);
                $location.path('/sua-pagina');
            }, function(response) {
                storage.deleteKey('user');
                $scope.msg = response.data.error;
            });
    }

    $scope.register = function() {
        $scope.form.password = $scope.passwordChoice.map(function(p) {
            return p.value;
        }).join('');

        if (!$scope.form.username || $scope.form.username.length < 1) {
            $scope.msg_register = 'Preencha seu apelido';
            return false;
        } else if (!$scope.form.email || $scope.form.email.length < 1) {
            $scope.msg_register = 'Email inválido';
            return false;
        } else if ($scope.form.password.length != 12) {
            console.log('password');
            $scope.msg_register = 'Senha inválida';
            return false;
        }
        $scope.msg_register = 'Cadastrar';
        $http.post("/user.json", {
                user: $scope.form
            }, {
                headers: { 'Content-Type': 'application/json' }
            })
            .then(function(response) {
                $scope.msg_register = 'Obrigado.';
                storage.set('user', response.data);
                $location.path('/sua-pagina');
            }, function(response) {
                storage.deleteKey('user');
                $scope.msg_register = response.error;
            });
    }

    $scope.msg_recover = 'Cadastrar nova senha.';

    $scope.recoverPass = function() {
        $scope.form.password = $scope.passwordChoice.map(function(p) {
            return p.value;
        }).join('');
        if ($scope.form.password.length != 12) {
            $scope.msg_recover = 'Senha inválida';
            return false;
        }
        $scope.msg_recover = 'Aguarde.';
        $http.post("/user.json", {
                user: $scope.form
            }, {
                headers: { 'Content-Type': 'application/json' }
            })
            .then(function(response) {
                $scope.msg_recover = 'Senha resetada com sucesso.';
            }, function(response) {
                $scope.msg_recover = response.error;
            });
    }

});
